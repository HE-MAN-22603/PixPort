{% extends "layout.html" %}

{% block title %}Result - {{ filename }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/result.css') }}">
{% endblock %}

{% block content %}
<div class="result-page">
    <!-- Success Header -->
    <div class="success-header">
        <div class="container">
            <div class="success-content">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="success-text">
                    <h1>Photo Ready!</h1>
                    <p>Your passport photo has been processed successfully</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="result-content">
            <!-- Image Result Section -->
            <div class="image-section">
                <div class="image-result">
                    <div class="result-container">
                        <img src="{{ url_for('static', filename='processed/' + filename) }}" 
                             alt="Processed Photo" 
                             class="result-image"
                             id="resultImage">
                        
                        <!-- Image Controls -->
                        <div class="image-controls">
                            <div class="zoom-controls">
                                <button class="control-btn" data-action="zoom-in" title="Zoom In">
                                    <i class="fas fa-search-plus"></i>
                                </button>
                                <button class="control-btn" data-action="zoom-out" title="Zoom Out">
                                    <i class="fas fa-search-minus"></i>
                                </button>
                                <button class="control-btn" data-action="reset" title="Reset View">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                            
                            <div class="view-controls">
                                <button class="control-btn comparison-toggle" title="Show Comparison">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="control-btn share-btn" title="Share">
                                    <i class="fas fa-share-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comparison View (Hidden by default) -->
                    <div class="comparison-container">
                        <div class="comparison-view">
                            <div class="comparison-item">
                                <h4>Before</h4>
                                <img src="" alt="Original" class="comparison-original">
                            </div>
                            <div class="comparison-divider">
                                <div class="divider-line"></div>
                                <div class="divider-handle">
                                    <i class="fas fa-arrows-alt-h"></i>
                                </div>
                            </div>
                            <div class="comparison-item">
                                <h4>After</h4>
                                <img src="{{ url_for('static', filename='processed/' + filename) }}" 
                                     alt="Processed" class="comparison-processed">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Download and Actions Section -->
            <div class="actions-section">
                <!-- Download Panel -->
                <div class="download-panel">
                    <h2>
                        <i class="fas fa-download"></i>
                        Download Your Photo
                    </h2>
                    
                    <!-- Quick Download Buttons -->
                    <div class="quick-downloads">
                        <button class="download-btn download-btn-main" 
                                data-format="JPEG" 
                                data-quality="95">
                            <i class="fas fa-download"></i>
                            Download JPEG (95%)
                        </button>
                        
                        <div class="download-options">
                            <button class="download-btn download-btn-secondary" 
                                    data-format="PNG" 
                                    data-quality="100">
                                <i class="fas fa-file-image"></i>
                                PNG
                            </button>
                            <button class="download-btn download-btn-secondary" 
                                    data-format="PDF" 
                                    data-quality="100">
                                <i class="fas fa-file-pdf"></i>
                                PDF
                            </button>
                        </div>
                    </div>
                    
                    <!-- Advanced Download Options -->
                    <div class="advanced-options">
                        <h3>Customize Download</h3>
                        
                        <div class="option-row">
                            <label for="download-format">Format:</label>
                            <select id="download-format">
                                <option value="JPEG">JPEG</option>
                                <option value="PNG">PNG</option>
                                <option value="WEBP">WebP</option>
                                <option value="PDF">PDF</option>
                            </select>
                        </div>
                        
                        <div class="option-row quality-row">
                            <label for="quality-slider">Quality:</label>
                            <div class="quality-control">
                                <input type="range" id="quality-slider" 
                                       min="60" max="100" value="95" step="5">
                                <span id="quality-value">95%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Download Statistics -->
                    <div class="download-stats">
                        <div class="stat-item">
                            <span class="stat-label">Downloads:</span>
                            <span class="stat-value download-count">0</span>
                        </div>
                    </div>
                </div>

                <!-- Additional Actions -->
                <div class="additional-actions">
                    <h3>What's Next?</h3>
                    
                    <div class="action-buttons">
                        <button class="action-btn process-again-btn">
                            <i class="fas fa-redo"></i>
                            <div class="action-content">
                                <span class="action-title">Process Again</span>
                                <span class="action-desc">Try different options</span>
                            </div>
                        </button>
                        
                        <button class="action-btn new-photo-btn">
                            <i class="fas fa-plus"></i>
                            <div class="action-content">
                                <span class="action-title">New Photo</span>
                                <span class="action-desc">Upload another image</span>
                            </div>
                        </button>
                        
                        <button class="action-btn copy-link-btn">
                            <i class="fas fa-link"></i>
                            <div class="action-content">
                                <span class="action-title">Copy Link</span>
                                <span class="action-desc">Share this result</span>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Image Statistics -->
                <div class="image-stats-panel">
                    <h3>Image Details</h3>
                    <div class="image-stats">
                        <!-- Stats will be populated by JavaScript -->
                        <div class="loading-stats">
                            <i class="fas fa-spinner fa-spin"></i>
                            Loading details...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Message (Toast) -->
    <div class="success-toast" id="successToast">
        <div class="toast-content">
            <i class="fas fa-check-circle"></i>
            <span class="toast-message">Photo processed successfully!</span>
        </div>
    </div>

    <!-- Processing Info -->
    {% if processing_info %}
    <div class="processing-info">
        <div class="container">
            <h3>Processing Summary</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Action:</span>
                    <span class="info-value">{{ processing_info.get('action', 'Unknown').title() }}</span>
                </div>
                
                <div class="info-item">
                    <span class="info-label">Processing Time:</span>
                    <span class="info-value">{{ "%.1f"|format(processing_info.get('processing_time', 0)) }}s</span>
                </div>
                
                {% if processing_info.get('options') %}
                <div class="info-item">
                    <span class="info-label">Options:</span>
                    <span class="info-value">{{ processing_info.options | join(', ') }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Print Styles (hidden) -->
<div class="print-only" style="display: none;">
    <div class="print-header">
        <h1>PixPort - AI Passport Photo</h1>
        <p>Generated on {{ moment().strftime('%B %d, %Y at %I:%M:%S %p') if moment else 'today' }}</p>
    </div>
    
    <div class="print-image">
        <img src="{{ url_for('static', filename='processed/' + filename) }}" 
             alt="Passport Photo">
    </div>
    
    <div class="print-info">
        <p>Visit <strong>pixport.ai</strong> to create more passport photos</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/result.js') }}"></script>
<script>
    // Show success animation on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-show success toast
        const successToast = document.getElementById('successToast');
        if (successToast) {
            successToast.classList.add('show');
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                successToast.classList.remove('show');
            }, 3000);
        }
        
        // Add confetti effect if available
        if (typeof confetti === 'function') {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
        }
    });
    
    // Print functionality
    function printResult() {
        // Show print elements
        const printElements = document.querySelectorAll('.print-only');
        printElements.forEach(el => el.style.display = 'block');
        
        // Hide screen elements
        const screenElements = document.querySelectorAll('.result-page > *:not(.print-only)');
        screenElements.forEach(el => el.style.display = 'none');
        
        // Print
        window.print();
        
        // Restore display
        setTimeout(() => {
            printElements.forEach(el => el.style.display = 'none');
            screenElements.forEach(el => el.style.display = '');
        }, 100);
    }
    
    // Add print keyboard shortcut
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'p') {
            e.preventDefault();
            printResult();
        }
    });

    // Track analytics if available
    if (typeof gtag === 'function') {
        gtag('event', 'photo_processed', {
            'filename': '{{ filename }}',
            'timestamp': new Date().toISOString()
        });
    }
    
    // Initialize result page features
    resultState.filename = '{{ filename }}';
    
    // Auto-load metadata
    loadImageMetadata();
    
    // Setup keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Only process if not in an input field
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        
        switch(e.key.toLowerCase()) {
            case 'd':
                e.preventDefault();
                document.querySelector('.download-btn-main')?.click();
                break;
            case 'n':
                e.preventDefault();
                document.querySelector('.new-photo-btn')?.click();
                break;
            case 'r':
                e.preventDefault();
                document.querySelector('.process-again-btn')?.click();
                break;
            case 'c':
                if (e.ctrlKey) {
                    e.preventDefault();
                    document.querySelector('.copy-link-btn')?.click();
                }
                break;
        }
    });
</script>
{% endblock %}
